<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Eltawell Chat</title>

<style>
body{font-family:Arial;background:#f2f2f2;padding:10px}
#chat{background:#fff;height:350px;overflow:auto;padding:10px;margin-bottom:10px}
.msg{margin:5px 0;padding:6px;border-radius:5px}
.me{background:#dcf8c6}
.other{background:#eee}
input,button{width:100%;padding:8px;margin:5px 0}
img,video,audio{max-width:100%;margin-top:5px}
</style>
</head>

<body>

<h4>ÙƒÙˆØ¯Ùƒ:</h4>
<div id="myId">...</div>

<input id="otherId" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ Ù‡ØªÙƒÙ„Ù…Ù‡">
<button onclick="startChat()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø§Øª</button>

<hr>

<div id="chat"></div>

<input id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
<button onclick="sendText()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</button>

<input type="file" id="fileInput" accept="image/*,video/*">
<button onclick="sendFile()">Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© / ÙÙŠØ¯ÙŠÙˆ</button>

<button onclick="startRecord()">ğŸ¤ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª</button>
<button onclick="stopRecord()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// ğŸ”´ Ø­Ø· Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø¨ØªØ§Ø¹ØªÙƒ Ù‡Ù†Ø§
const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  projectId: "PROJECT_ID",
  storageBucket: "PROJECT.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let myUid=null, chatId=null, unsub=null;

// ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„
auth.signInAnonymously();
auth.onAuthStateChanged(u=>{
  if(u){
    myUid=u.uid;
    document.getElementById("myId").innerText=myUid;
  }
});

// Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø§Øª Ø´Ø®ØµÙŠ
function startChat(){
  const other=document.getElementById("otherId").value.trim();
  if(!other){alert("Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯");return;}

  chatId = myUid < other ? myUid+"_"+other : other+"_"+myUid;
  if(unsub)unsub();

  unsub = db.collection("chats").doc(chatId)
    .collection("messages")
    .orderBy("time")
    .onSnapshot(snap=>{
      chat.innerHTML="";
      snap.forEach(d=>{
        const m=d.data();
        const cls=m.sender===myUid?"me":"other";
        let html=`<div class="msg ${cls}">`;

        if(m.type==="text") html+=m.text;
        if(m.type==="image") html+=`<img src="${m.url}">`;
        if(m.type==="video") html+=`<video controls src="${m.url}"></video>`;
        if(m.type==="audio") html+=`<audio controls src="${m.url}"></audio>`;

        html+="</div>";
        chat.innerHTML+=html;
      });
      chat.scrollTop=chat.scrollHeight;
    });
}

// Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ
function sendText(){
  const t=msg.value.trim();
  if(!t||!chatId)return;

  db.collection("chats").doc(chatId)
    .collection("messages")
    .add({
      type:"text",
      text:t,
      sender:myUid,
      time:firebase.firestore.FieldValue.serverTimestamp()
    });
  msg.value="";
}

// Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© / ÙÙŠØ¯ÙŠÙˆ
function sendFile(){
  if(!chatId)return;
  const file=fileInput.files[0];
  if(!file)return;

  const type=file.type.startsWith("image")?"image":"video";
  const ref=storage.ref("media/"+Date.now()+"_"+file.name);

  ref.put(file).then(s=>
    s.ref.getDownloadURL().then(url=>{
      db.collection("chats").doc(chatId)
        .collection("messages")
        .add({
          type:type,
          url:url,
          sender:myUid,
          time:firebase.firestore.FieldValue.serverTimestamp()
        });
    })
  );
}

// ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª
let recorder,chunks=[];
function startRecord(){
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    recorder=new MediaRecorder(stream);
    chunks=[];
    recorder.start();
    recorder.ondataavailable=e=>chunks.push(e.data);
  });
}

function stopRecord(){
  if(!recorder)return;
  recorder.stop();
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:"audio/webm"});
    const ref=storage.ref("voices/"+Date.now()+".webm");
    ref.put(blob).then(s=>
      s.ref.getDownloadURL().then(url=>{
        db.collection("chats").doc(chatId)
          .collection("messages")
          .add({
            type:"audio",
            url:url,
            sender:myUid,
            time:firebase.firestore.FieldValue.serverTimestamp()
          });
      })
    );
  };
}
</script>

</body>
</html>
