<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #004d40; --accent: #2ecc71; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: sans-serif; background: var(--primary); color: white; overflow: hidden; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ - Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ø§Ù„Ø¸Ù‡ÙˆØ± ÙˆØ§Ù„Ø¹Ù…Ù„ */
        #gate { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--primary); z-index: 999999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }
        .enter-btn { 
            background: var(--accent); color: white; border: none; padding: 20px 80px; 
            border-radius: 50px; font-size: 24px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); -webkit-tap-highlight-color: transparent;
        }

        #main-ui { display: none; height: 100vh; flex-direction: column; background: #efe7de; color: black; }
        .header { background: #34b7f1; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        #list { flex: 1; overflow-y: auto; background: white; }
    </style>
</head>
<body>

<div id="gate">
    <img src="https://cdn-icons-png.flaticon.com/512/134/134914.png" width="100" style="margin-bottom:30px">
    <h2 style="margin-bottom:40px">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø´Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„</h2>
    <button class="enter-btn" onclick="document.getElementById('gate').style.display='none'; document.getElementById('main-ui').style.display='flex'; startEverything();">
        ØªÙØ¹ÙŠÙ„ ÙˆØ¯Ø®ÙˆÙ„ ğŸ”
    </button>
</div>

<div id="main-ui">
    <div class="header">
        <span>Eltaweel Chat</span>
        <small id="me"></small>
    </div>
    <div id="list"></div>
    <button onclick="add()" style="position:fixed; bottom:20px; left:20px; width:60px; height:60px; border-radius:50%; background:var(--accent); color:white; border:none; font-size:30px;">+</button>
</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† ØµÙˆØ±Ùƒ
    const config = {
        apiKey: "AIzaSyDRdboeLuFYh_paYHem0SbgCar4bGgBFSI",
        authDomain: "eltaweel-chat.firebaseapp.com",
        projectId: "eltaweel-chat",
        storageBucket: "eltaweel-chat.firebasestorage.app",
        messagingSenderId: "870673668921",
        appId: "1:870673668921:web:7120ac95978158c963a6e8",
        databaseURL: "https://eltaweel-chat-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(config);
    const auth = firebase.auth(), db = firebase.firestore();
    let myId, myNum;

    function startEverything() {
        console.log("System Started");
        if ("Notification" in window) Notification.requestPermission();
        document.getElementById('beep').play().then(p => { 
            document.getElementById('beep').pause(); 
        }).catch(e => {});
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            myId = user.uid;
            db.collection("users").doc(myId).get().then(doc => {
                if (!doc.exists) {
                    let p = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ:");
                    if(p) db.collection("users").doc(myId).set({phone: p, uid: myId}).then(()=>location.reload());
                } else {
                    myNum = doc.data().phone;
                    document.getElementById('me').innerText = myNum;
                    load();
                }
            });
        } else {
            auth.signInAnonymously();
        }
    });

    function load() {
        db.collection("users").doc(myId).collection("myChats").onSnapshot(snap => {
            const l = document.getElementById('list');
            l.innerHTML = "";
            snap.forEach(d => {
                const f = d.data();
                const item = document.createElement('div');
                item.style = "padding:20px; border-bottom:1px solid #eee; font-weight:bold;";
                item.innerText = f.nickname;
                item.onclick = () => alert("Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø´Ø§Øª " + f.nickname);
                l.appendChild(item);
            });
        });
    }

    function add() {
        let p = prompt("Ø±Ù‚Ù… Ø§Ù„ØµØ¯ÙŠÙ‚:");
        db.collection("users").where("phone", "==", p).get().then(s => {
            if(s.empty) return alert("ØºÙŠØ± Ù…Ø³Ø¬Ù„");
            db.collection("users").doc(myId).collection("myChats").doc(s.docs[0].id).set({id: s.docs[0].id, nickname: p});
        });
    }
</script>
</body>
</html>
