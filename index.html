<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø´Ø§Øª Ø®Ø§Øµ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    body { font-family: Arial; background:#f5f5f5; margin:0; padding:10px }
    input, button { width:100%; padding:10px; margin:5px 0 }
    #chat { height:300px; overflow-y:auto; background:#fff; padding:10px; margin-top:10px }
    .msg { margin:5px 0; padding:5px; border-radius:5px }
    .me { background:#d1ffd1 }
    .other { background:#eee }
  </style>
</head>
<body>

<h3>Ø´Ø§Øª Ø®Ø§Øµ</h3>

<input id="myCode" placeholder="ÙƒÙˆØ¯Ùƒ (Ù…Ø«Ù„Ø§Ù‹: mohamed123)">
<input id="friendCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ Ù‡ØªÙƒÙ„Ù…Ù‡">
<button onclick="startChat()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø§Øª</button>

<div id="chat"></div>

<input id="message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©">
<button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>

<button onclick="recordVoice()">ðŸŽ¤ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª</button>

<script>
  // ðŸ”´ ØºÙŠÙ‘Ø± Ø§Ù„Ù‚ÙŠÙ… Ø¯ÙŠ Ø¨Ø³
  const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
    storageBucket: "PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  let chatId = "";
  let unsubscribe = null;

  auth.signInAnonymously();

  function startChat() {
    const me = myCode.value.trim();
    const friend = friendCode.value.trim();

    if (!me || !friend) {
      alert("Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ÙŠÙ†");
      return;
    }

    chatId = [me, friend].sort().join("_");

    if (unsubscribe) unsubscribe();

    unsubscribe = db.collection("chats")
      .doc(chatId)
      .collection("messages")
      .orderBy("time")
      .onSnapshot(snapshot => {
        chat.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "msg " + (data.sender === me ? "me" : "other");

          if (data.type === "text") {
            div.innerText = data.text;
          } else {
            div.innerHTML = `<audio controls src="${data.url}"></audio>`;
          }

          chat.appendChild(div);
          chat.scrollTop = chat.scrollHeight;
        });
      });
  }

  function sendMessage() {
    const text = message.value.trim();
    if (!text || !chatId) return;

    db.collection("chats")
      .doc(chatId)
      .collection("messages")
      .add({
        sender: myCode.value,
        text: text,
        type: "text",
        time: firebase.firestore.FieldValue.serverTimestamp()
      });

    message.value = "";
  }

  let recorder;
  let audioChunks = [];

  async function recordVoice() {
    if (!chatId) return alert("Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø£ÙˆÙ„");

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);
    audioChunks = [];

    recorder.ondataavailable = e => audioChunks.push(e.data);
    recorder.onstop = uploadVoice;

    recorder.start();
    setTimeout(() => recorder.stop(), 5000);
  }

  function uploadVoice() {
    const blob = new Blob(audioChunks, { type: "audio/webm" });
    const ref = storage.ref("voices/" + Date.now() + ".webm");

    ref.put(blob).then(() => {
      ref.getDownloadURL().then(url => {
        db.collection("chats")
          .doc(chatId)
          .collection("messages")
          .add({
            sender: myCode.value,
            url: url,
            type: "voice",
            time: firebase.firestore.FieldValue.serverTimestamp()
          });
      });
    });
  }
</script>

</body>
</html>
